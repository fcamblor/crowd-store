<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.1//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.crowdstore.persistence.store.StoreDaoImpl">

    <insert id="createStore" parameterType="com.crowdstore.models.store.FlatStore"
            useGeneratedKeys="true" keyProperty="identity.id">
        INSERT INTO store(name, logically_deleted)
        VALUES (#{identity.name}, 1)
    </insert>

    <select id="getStoreUsers" parameterType="String" resultMap="com.crowdstore.persistence.mappings.users.UserIdentity">
        SELECT U.id as 'id', U.FIRST_NAME as 'first_name', U.LAST_NAME as 'last_name', U.EMAIL as 'email'
        FROM user U
        INNER JOIN user_store US ON US.store_id = U.id
        INNER JOIN store S ON US.store_id = S.id
        WHERE S.name = #{param}
    </select>

    <delete id="deleteStoresByNames" parameterType="String[]">
        DELETE FROM store
        WHERE name IN
        <foreach collection="array" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>

    </delete>

</mapper>